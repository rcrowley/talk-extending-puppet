!SLIDE bullets

# Extending Puppet

* [rcrowley.org/talks/puppet-camp-eu-2011/](http://rcrowley.org/talks/puppet-camp-eu-2011/)



!SLIDE bullets

# Hi, I&#8217;m Richard Crowley

* Equal opportunity technology hater.
* DevStructure&#8217;s operator and UNIX hacker.



!SLIDE bullets

## Part 1

# Custom types

## (Warmup.)



!SLIDE bullets small

# How I&#8217;m running Puppet

	[main]
		confdir = /home/rcrowley/work/extending-puppet
		logdir = /var/log/puppet
	    rundir = /var/run/puppet
	    ssldir = $vardir/ssl
	    vardir = /var/lib/puppet

	    pluginsync = true



!SLIDE bullets small

# How I&#8217;m running Puppet

	@@@ sh
	# Master
	puppet master --confdir=$HOME/work/extending-puppet

	# Agent
	puppet agent --confdir=$HOME/work/extending-puppet



!SLIDE bullets small

# How I&#8217;m running Puppet

* [github.com/rcrowley/extending-puppet](https://github.com/rcrowley/extending-puppet)



!SLIDE bullets

# Plugins in modules

* Not just &#8220;plugins.&#8221;
* Any Puppet source tree.
* Monkey patches, too.



!SLIDE bullets

# Custom types

	@@@ Ruby
	Puppet::Type.newtype :foo do

	  # TODO Properties and parameters.

	end



!SLIDE bullets

# Properties

	@@@ Ruby
	newproperty :foo do
	  desc "Foo."
	  newvalue :bar
	  newvalue :baz
	end

	newproperty :quux do
	  desc "Quux."
	end



!SLIDE bullets

# Properties

* Things written to disk.
* `provider.foo` called to read.
* `provider.foo=` called to write.



!SLIDE bullets

# Properties

* No explicit, documented<br />guarantees on order.
* Hard to work with in procedural code.



!SLIDE bullets

# Using properties effectively

* Use only one property per type.
* Usually, this is the `ensure` property.



!SLIDE bullets

# `ensure` property

* `exists?`
* `create`
* `destroy`


!SLIDE bullets smaller

# `ensure` property

	@@@ Ruby
	    newvalue(:present) do
	      if @resource.provider and
	         @resource.provider.respond_to?(:create)
	        @resource.provider.create
	      else
	        @resource.create
	      end
	      nil # return nil so the event is autogenerated
	    end

	    newvalue(:absent) do
	      if @resource.provider and
	         @resource.provider.respond_to?(:destroy)
	        @resource.provider.destroy
	      else
	        @resource.destroy
	      end
	      nil # return nil so the event is autogenerated
	    end



!SLIDE bullets

# Parameters

	@@@ Ruby
	newparam :foo do
	  desc "Foo."
	  newvalue :bar
	  newvalue :baz
	end

	newparam :quux do
	  desc "Quux."
	end



!SLIDE bullets

# Parameters

* Configure the resource.
* No associated actions.
* Use as many as you need.



!SLIDE bullets

# Types versus providers

* A `package` is a type.<br />`apt` is a provider of packages.
* Types parse and normalize arguments.<br />Providers make it so.



!SLIDE bullets

# GitHub authorized keys



!SLIDE bullets smaller

# `lib/puppet/type/github.rb`

	@@@ Ruby
	require 'puppet/type'

	Puppet::Type.newtype :github do
	  @doc = "Send a public key to GitHub."

	  newparam :path, :namevar => true do
	    desc "Private key pathname."
	  end

	  newparam :username do
	    desc "GitHub username."
	  end

	  newparam :token do
	    desc "GitHub API token."
	  end

	  ensurable do
	    defaultvalues
	    defaultto :present
	  end

	end



!SLIDE bullets small

# Example resource

	@@@ Puppet
	github { "/root/.ssh/github":
	    ensure   => present,
	    token    => "0123456789abcdef0123456789abcdef",
	    username => "rcrowley",
	}



!SLIDE bullets smaller

# `lib/puppet/provider/github/https.rb`

	@@@ Ruby
	require 'base64'
	require 'json'
	require 'net/http'
	require 'net/https'
	require 'openssl'

	Puppet::Type.type(:github).provide :https do
	  @doc = "Send a public key to GitHub."

	  defaultfor :operatingsystem => :ubuntu

	  # TODO exists?, create, destroy

	  # TODO private methods

	end



!SLIDE bullets smaller

# `lib/puppet/provider/github/https.rb`

	@@@ Ruby
	  def exists?
	    return false unless File.exists?("#{@resource[:path]}")
	    return false unless File.exists?("#{@resource[:path]}.pub")
	    !github_id.nil?
	  end

	  def create
	    system "ssh-keygen -q -f '#{@resource[:path]
	      }' -b 2048 -N '' -C ''"
	    POST("/api/v2/json/user/key/add",
	      :title => File.basename("#{@resource[:path]}"),
	      :key => File.read("#{@resource[:path]}.pub"))
	  end

	  def destroy
	    if id = github_id
	      POST("/api/v2/json/user/key/remove", :id => id)
	    end
	    File.unlink "#{@resource[:path]}"
	    File.unlink "#{@resource[:path]}.pub"
	  end



!SLIDE bullets smaller

# `lib/puppet/provider/github/https.rb`

	@@@ Ruby
	private

	  def github_id
	    public_key = File.read("#{@resource[:path]}.pub").strip
	    JSON.parse(
	      GET("/api/v2/json/user/keys").body,
	      :symbolize_names => true
	    )[:public_keys].find { |gh| gh[:key] == public_key }[:id]
	  rescue NoMethodError
	    nil
	  end



!SLIDE bullets smaller

# `lib/puppet/provider/github/https.rb`

	@@@ Ruby
	private

	  def GET(path)
	    request = Net::HTTP::Get.new(path)
	    authorize(request)
	    connection.request(request)
	  end

	  def POST(path, options={})
	    request = Net::HTTP::Post.new(path)
	    authorize(request)
	    request.set_form_data(options)
	    connection.request(request)
	  end



!SLIDE bullets smaller

# `lib/puppet/provider/github/https.rb`

	@@@ Ruby
	private

	  def connection
	    return @connection if defined?(@connection)
	    @connection = Net::HTTP.new("github.com", 443)
	    @connection.use_ssl = true
	    @connection.verify_mode = OpenSSL::SSL::VERIFY_NONE
	    @connection
	  end

	  def authorize(request)
	    request["Authorization"] = "Basic #{Base64.encode64(
	      "#{@resource[:username]}/token:#{@resource[:token]}"
	    ).gsub("\n", "")}"
	  end



!SLIDE bullets

* [github.com/rcrowley/extending-puppet](https://github.com/rcrowley/extending-puppet)



!SLIDE bullets

# Providers for<br />existing types



!SLIDE bullets

# `puppet-pip`

* `package` provider for Python&#8217;s<br />`pip` package management tool.
* Included in Puppet 2.7 release candiate.



!SLIDE bullets

# Install `puppet-pip` on 2.6

	@@@ sh
	gem install puppet-pip

	export \
		RUBYLIB=$GEM_HOME/puppet-pip-1.0.0/lib



!SLIDE bullets smaller

# `lib/puppet/provider/package/pip.rb`

	@@@ Ruby
	require 'puppet/provider/package'
	require 'xmlrpc/client'

	Puppet::Type.type(:package).provide :pip,
	  :parent => ::Puppet::Provider::Package do

	  desc "Python packages via `pip`."

	  has_feature :installable, :uninstallable,
		:upgradeable, :versionable

	  # TODO self.parse, self.instances,
	  # TODO query, latest, install, uninstall, update,
	  # TODO lazy_pip

	end



!SLIDE bullets smaller

# `lib/puppet/provider/package/pip.rb`

	@@@ Ruby
	  def self.parse(line)
	    if line.chomp =~ /^([^=]+)==([^=]+)$/
	      {:ensure => $2, :name => $1, :provider => name}
	    else
	      nil
	    end
	  end

	  def self.instances
	    packages = []
	    pip_cmd = which('pip') or return []
	    execpipe "#{pip_cmd} freeze" do |process|
	      process.collect do |line|
	        next unless options = parse(line)
	        packages << new(options)
	      end
	    end
	    packages
	  end



!SLIDE bullets smaller

# `lib/puppet/provider/package/pip.rb`

	@@@ Ruby
	  def query
	    self.class.instances.each do |provider_pip|
	      if @resource[:name] == provider_pip.name
	        return provider_pip.properties
	      end
	    end
	    return nil
	  end

	  def latest
	    client = XMLRPC::Client.new2("http://pypi.python.org/pypi")
	    client.http_header_extra = {"Content-Type" => "text/xml"}
	    result = client.call("package_releases", @resource[:name])
	    result.first
	  end


!SLIDE bullets smaller

# `lib/puppet/provider/package/pip.rb`

	@@@ Ruby
	  def install
	    args = %w{install -q}
	    if @resource[:source]
	      args << "-e"
	      if String === @resource[:ensure]
	        args << "#{@resource[:source]}@#{@resource[:ensure]}" +
	          "#egg=#{@resource[:name]}"
	      else
	        args << "#{@resource[:source]}#egg=#{@resource[:name]}"
	      end
	    else
	      case @resource[:ensure]
	      when String
	        args << "#{@resource[:name]}==#{@resource[:ensure]}"
	      when :latest
	        args << "--upgrade" << @resource[:name]
	      else
	        args << @resource[:name]
	      end
	    end
	    lazy_pip *args
	  end



!SLIDE bullets smaller

# `lib/puppet/provider/package/pip.rb`

	@@@ Ruby
	  def uninstall
	    lazy_pip "uninstall", "-y", "-q", @resource[:name]
	  end



!SLIDE bullets smaller

# `lib/puppet/provider/package/pip.rb`

	@@@ Ruby
	  def update
	    install
	  end



!SLIDE bullets smaller

# `lib/puppet/provider/package/pip.rb`

	@@@ Ruby
	  private
	  def lazy_pip(*args)
	    pip *args
	  rescue NoMethodError => e
	    if pathname = which('pip')
	      self.class.commands :pip => pathname
	      pip *args
	    else
	      raise e
	    end
	  end



!SLIDE bullets

# Example resource

	@@@ Puppet
	package { "django":
		ensure   => "1.3",
		provider => pip,
	}



!SLIDE bullets

* [github.com/rcrowley/puppet-pip](https://github.com/rcrowley/puppet-pip)
* [github.com/puppetlabs/puppet/tree/next](https://github.com/puppetlabs/puppet/tree/next)



!SLIDE bullets

## Part 2

# Custom functions

## (Because the Puppet master<br />needs more things to do.)



!SLIDE bullets

# GitHub authorized keys

## Redux

* Don&#8217;t share GitHub API token with agents.



!SLIDE bullets

# Example resource

	@@@ Puppet
	file { "/root/.ssh/github":
		content => github(
			"my sweet public key",
			"rcrowley",
			"0123456789abcdef0123456789abcdef"
		),
		ensure => file,
		group => "root",
		mode => 0600,
		owner => "root",
	}



!SLIDE bullets smaller

# `lib/puppet/parser/ functions/github.rb`

	@@@ Ruby
	require 'base64'
	require 'net/https'
	require 'sshkey'

	Puppet::Parser::Functions.newfunction :github,
	  :type => :rvalue do |args|

	  # TODO Check GitHub for an existing public key.

	  key = SSHKey.generate
	  request = Net::HTTP::Post.new("/api/v2/json/user/key/add")
	  request["Authorization"] = "Basic #{Base64.encode64(
	    "#{args[1]}/token:#{args[2]}").gsub("\n", "")}"
	  request.set_form_data(
	    :title => args[0], :key => key.ssh_public_key)

	  connection = Net::HTTP.new("github.com", 443)
	  connection.use_ssl = true
	  connection.request(request)

	  key.rsa_private_key
	end



!SLIDE bullets

* [github.com/rcrowley/extending-puppet](https://github.com/rcrowley/extending-puppet)



!SLIDE bullets

## Part 3

# WTF is an indirector?

## (It&#8217;s not even in the dictionary.)



!SLIDE bullets

# Node terminus

	$ puppet --genconfig | grep node_terminus
	    # node_terminus = plain
	$



!SLIDE bullets small

# From `lib/puppet/ indirector/node/plain.rb`

	@@@ Ruby
	require 'puppet/node'
	require 'puppet/indirector/plain'

	class Puppet::Node::Plain < Puppet::Indirector::Plain
	  # ...

	  # Just return an empty node.
	  def find(request)
	    node = super
	    node.fact_merge
	    node
	  end
	end



!SLIDE bullets smaller

# From `lib/puppet/indirector/plain.rb`

	@@@ Ruby
	require 'puppet/indirector/terminus'

	# An empty terminus type, meant to just return empty objects.
	class Puppet::Indirector::Plain < Puppet::Indirector::Terminus
	  # Just return nothing.
	  def find(request)
	    indirection.model.new(request.key)
	  end
	end



!SLIDE bullets

# How did we get here?

	@@@ Ruby
	  def find(request)
	    puts caller
	    indirection.model.new(request.key)
	  end



!SLIDE bullets smaller

# How did we get here?

<pre>
lib/puppet/indirector/node/plain.rb:15:in `find'
lib/puppet/indirector/indirection.rb:193:in `find'
lib/puppet/indirector/catalog/compiler.rb:91:in `find_node'
lib/puppet/indirector/catalog/compiler.rb:119:in `node_from_request'
lib/puppet/indirector/catalog/compiler.rb:33:in `find'
lib/puppet/indirector/indirection.rb:193:in `find'
lib/puppet/network/http/handler.rb:106:in `do_find'
lib/puppet/network/http/handler.rb:68:in `send'
lib/puppet/network/http/handler.rb:68:in `process'
lib/puppet/network/http/webrick/rest.rb:24:in `service'
# ...
</pre>



!SLIDE bullets

# `Puppet::Indirector:: Indirection#find`

* Picks and caches the terminus class.
* Dispatches calls to it.



!SLIDE bullets smaller

<pre>
lib/puppet/indirector/node/plain.rb:15:in `find'
lib/puppet/indirector/indirection.rb:193:in `find'
lib/puppet/indirector/catalog/compiler.rb:91:in `find_node'
lib/puppet/indirector/catalog/compiler.rb:119:in `node_from_request'
<strong>lib/puppet/indirector/catalog/compiler.rb:33:in `find'</strong>
lib/puppet/indirector/indirection.rb:193:in `find'
lib/puppet/network/http/handler.rb:106:in `do_find'
lib/puppet/network/http/handler.rb:68:in `send'
lib/puppet/network/http/handler.rb:68:in `process'
lib/puppet/network/http/webrick/rest.rb:24:in `service'
# ...
</pre>



!SLIDE bullets smaller

# What&#8217;s the node object for?

	@@@ Ruby
	  def find(request)
	    extract_facts_from_request(request)

	    node = node_from_request(request)

	    if catalog = compile(node)
	      return catalog
	    else
	      # This shouldn't actually happen; we should either return
	      # a config or raise an exception.
	      return nil
	    end
	  end



!SLIDE bullets

# A node to compile

	@@@ Ruby
	  def find(request)
	    indirection.model.new(request.key)
	  end

* `indirection.model` returns `Puppet::Node`.
* A `Puppet::Node` has `@parameters` and `@classes`.
* The node terminus should populate `@parameters` and `@classes`.



!SLIDE bullets

# Catalog compilation



!SLIDE bullets smaller

# From `lib/puppet/parser/compiler.rb`

	@@@ Ruby
	  def compile
	    # Set the client's parameters into the top scope.
	    set_node_parameters
	    create_settings_scope

	    evaluate_main

	    evaluate_ast_node

	    evaluate_node_classes

	    evaluate_generators

	    finish

	    fail_on_unevaluated

	    @catalog
	  end



!SLIDE bullets

# Catalog compilation

* `set_node_parameters` and `evaluate_node_classes` handle<br />`@parameters` and `@classes`<br />set by the node terminus.
* `evaluate_ast_node` handles<br />`node` definitions from Puppet code.



!SLIDE bullets

# `@parameters` and `@classes`

* Sound suspiciously like the makings<br />of the external node classifier.



!SLIDE bullets

# Setup external node classifier in `puppet.conf`

	external_nodes = /usr/local/bin/classifier
	node_terminus = exec



!SLIDE bullets

# `/usr/local/bin/classifier`

	@@@ sh
	#!/bin/sh
	cat <<EOF
	---
	classes: []
	parameters:
	  foo: bar
	EOF



!SLIDE bullets

# From `lib/puppet/ indirector/node/exec.rb`

	@@@ Ruby
	  def find(request)
	    output = super or return nil

	    # Translate the output to ruby.
	    result = translate(request.key, output)

	    create_node(request.key, result)
	  end



!SLIDE bullets

# From `lib/puppet/ indirector/exec.rb`

	@@@ Ruby
	  def find(request)
	    # Run the command.
	    unless output = query(request.key)
	      return nil
	    end

	    # Translate the output to ruby.
	    output
	  end



!SLIDE bullets

# How did we get here?

	@@@ Ruby
	  def find(request)
	    puts caller
	    # Run the command.
	    unless output = query(request.key)
	      return nil
	    end

	    # Translate the output to ruby.
	    output
	  end



!SLIDE bullets smaller

# How did we get here?

<pre>
lib/puppet/indirector/node/exec.rb:17:in `find'
lib/puppet/indirector/indirection.rb:193:in `find'
lib/puppet/indirector/catalog/compiler.rb:91:in `find_node'
lib/puppet/indirector/catalog/compiler.rb:119:in `node_from_request'
lib/puppet/indirector/catalog/compiler.rb:33:in `find'
lib/puppet/indirector/indirection.rb:193:in `find'
lib/puppet/network/http/handler.rb:106:in `do_find'
lib/puppet/network/http/handler.rb:68:in `send'
lib/puppet/network/http/handler.rb:68:in `process'
lib/puppet/network/http/webrick/rest.rb:24:in `service'
# ...
</pre>



!SLIDE bullets

# Node terminus indirected

* As expected, everything&#8217;s the same except where the indirector looked for the node.

* Where&#8217;s that `foo` parameter injected by the external node classifier?



!SLIDE bullets smaller

<pre>
lib/puppet/indirector/node/exec.rb:17:in `find'
lib/puppet/indirector/indirection.rb:193:in `find'
<strong>lib/puppet/indirector/catalog/compiler.rb:91:in `find_node'</strong>
lib/puppet/indirector/catalog/compiler.rb:119:in `node_from_request'
lib/puppet/indirector/catalog/compiler.rb:33:in `find'
lib/puppet/indirector/indirection.rb:193:in `find'
lib/puppet/network/http/handler.rb:106:in `do_find'
lib/puppet/network/http/handler.rb:68:in `send'
lib/puppet/network/http/handler.rb:68:in `process'
lib/puppet/network/http/webrick/rest.rb:24:in `service'
# ...
</pre>



!SLIDE bullets smaller

# From `lib/puppet/ indirector/catalog/compiler.rb`

	@@@ Ruby
	  def find_node(name)
	    begin
	      return nil unless node =
	        Puppet::Node.indirection.find(name)
	    rescue => detail
	      puts detail.backtrace if Puppet[:trace]
	      raise Puppet::Error,
	        "Failed when searching for node #{name}: #{detail}"
	    end


	    # Add any external data to the node.
	    add_node_data(node)

	    node
	  end



!SLIDE bullets smaller

# What&#8217;s in a `node`?

	@@@ Ruby
	  def find_node(name)
	    begin
	      return nil unless node =
	        Puppet::Node.indirection.find(name)
	    rescue => detail
	      puts detail.backtrace if Puppet[:trace]
	      raise Puppet::Error,
	        "Failed when searching for node #{name}: #{detail}"
	    end


	    # Add any external data to the node.
	    add_node_data(node)

	    puts node.inspect
	    node
	  end



!SLIDE bullets smaller

# What&#8217;s in a `node`?

<pre>
#&lt;Puppet::Node:0xb70fa674 @name="devstructure.hsd1.ca.comcast.net.",
@classes={}, @expiration=Sat Jan 08 22:47:33 +0000 2011,
@parameters={"network_eth1"=&gt;"33.33.33.0", "netmask"=&gt;"255.255.255.0",
"kernel"=&gt;"Linux", "processorcount"=&gt;"1", "swapfree"=&gt;"998.67 MB",
"physicalprocessorcount"=&gt;"0", "uniqueid"=&gt;"007f0101",
"lsbmajdistrelease"=&gt;"10", "fqdn"=&gt;"devstructure.hsd1.ca.comcast.net.",
"operatingsystemrelease"=&gt;"10.10", "virtual"=&gt;"physical",
"ipaddress"=&gt;"10.0.2.15", "memorysize"=&gt;"346.15 MB",
"is_virtual"=&gt;"false", :_timestamp=&gt;Sat Jan 08 22:17:32 +0000 2011,
"clientversion"=&gt;"2.6.4", "hardwaremodel"=&gt;"i686",
"kernelrelease"=&gt;"2.6.35-22-generic-pae",
"rubysitedir"=&gt;"/usr/local/lib/site_ruby/1.8", "ps"=&gt;"ps -ef",
"macaddress_eth0"=&gt;"08:00:27:8e:9e:65", "domain"=&gt;"hsd1.ca.comcast.net.",
"netmask_eth0"=&gt;"255.255.255.0", "serverip"=&gt;"10.0.2.15",
"servername"=&gt;"devstructure.hsd1.ca.comcast.net.", "timezone"=&gt;"UTC",
"uptime_days"=&gt;"9", "macaddress_eth1"=&gt;"08:00:27:c3:78:5a", "id"=&gt;"root",
"netmask_eth1"=&gt;"255.255.255.0", "processor0"=&gt;"Intel(R) Core(TM)2 Duo CPU
T8300  @ 2.40GHz", "hardwareisa"=&gt;"unknown", "lsbdistrelease"=&gt;"10.10",
"selinux"=&gt;"false", "manufacturer"=&gt;"innotek GmbH", "interfaces"=&gt;"eth0,eth1",
"memoryfree"=&gt;"225.10 MB", "uptime_hours"=&gt;"216", <strong>"foo"=&gt;"bar"</strong>,
"lsbdistdescription"=&gt;"Ubuntu 10.10", "lsbdistcodename"=&gt;"maverick", "kernelversion"=&gt;"2.6.35", "path"=&gt;"/home/vagrant/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/var/lib/gems/1.8/bin", "hostname"=&gt;"devstructure", "uptime"=&gt;"9 days", "puppetversion"=&gt;"2.6.4", "environment"=&gt;"production", "serialnumber"=&gt;"0", "macaddress"=&gt;"08:00:27:8e:9e:65", "facterversion"=&gt;"1.5.8", "ipaddress_eth0"=&gt;"10.0.2.15", "kernelmajversion"=&gt;"2.6", "swapsize"=&gt;"1011.00 MB", "sshrsakey"=&gt;"AAAAB3NzaC1yc2EAAAADAQABAAABAQDrJ0U+iSED6LNmnC0bHfpLKaDvWh0UXgQzdElhtY1xOS065TRMJIrb6LPaAxJH3iWXLP57rM8Vldurx+pOJWVz6ZmsGSz/EOugg6rC6K2cPAS8V5nRq6SUKksb/eBR0LbM0ygMoVEKi0ogBIkQuZNeVqdUtIcT5P7DBrasPkxzkBqxqAgYxzMeR82vYSLBEwhpeyrVUzpOHLh9mVxfCQoZRdEpnckGmMxYSOW7OBzf46CBhPrXAB5ZX3aZB+iDxNhMVvMYZFircDb/ZKZ4ph6qHFVWvBtd54N9yXf+XSLZPfox4zIRR8BRoUz8rx7ccZDZ6SWVdMCZ6jO3MuxEIeFJ", "operatingsystem"=&gt;"Ubuntu", "serverversion"=&gt;"2.6.4", "network_eth0"=&gt;"10.0.2.0", "lsbdistid"=&gt;"Ubuntu", "architecture"=&gt;"i386", "uptime_seconds"=&gt;"779012", "sshdsakey"=&gt;"AAAAB3NzaC1kc3MAAACBAJNDwltq7JCbq7ql1a3g2IxLWwhJNLxk0jYj/oLLc7LvpiN1kcfuNoK2bZooUCnGkcyZs+6U3jbz2idISOncq+hfFjrMv0qIGKHXWANh1qLZuhRjBHwRlkD6ll5gw4ioTohmt3VfUbE4hJfK0z3wtQn/SLLoz4MSNnR09OIZOCgzAAAAFQDLW+bfrDl+WdsE4ixDCRr4vEW1lwAAAIBt+Bz62PhQLZSWpLaHCOOaFeoHwv9IPvQ/ors0zDOxDEoK5GHOY3BcCO8s4rHr17aQKmMP5ztNwzUBl+OlkSlQ7kAEMBRvehFbhK+SOcjvqIt6i2i9/3nn9ba0AZ8bQ+1T8Z+A/6lRmWtaeUqsZNRJitfzez7eWRfvd+X/GK1eaAAAAIAqyACyAElrdGd4YfwV/YPGjiUpIjvzqiBCogO2qvMj6/ohzdN7wBmIdIUmYQ1uYsQ6avd3GL5S2I/xJ1uGosIh6xlKa0Dk4SqOq1LGebdCpv1aUKIwecQlkxrQE6Da9Q4zVgHrtlglOW7A8uq8gfl/VQdwU1sow36scLSE8PCn/g==", "rubyversion"=&gt;"1.8.7", "ipaddress_eth1"=&gt;"33.33.33.33", "productname"=&gt;"VirtualBox", "clientcert"=&gt;"devstructure.hsd1.ca.comcast.net."}, @time=Sat Jan 08 22:17:33 +0000 2011, @environment="production"&gt;
</pre>

* `foo` is indeed `bar` but where&#8217;d the rest of the facts come from?



!SLIDE bullets small

# From `lib/puppet/ indirector/node/exec.rb`

	@@@ Ruby
	  def create_node(name, result)
	    node = Puppet::Node.new(name)
	    set = false
	    [:parameters, :classes, :environment].each do |param|
	      if value = result[param]
	        node.send(param.to_s + "=", value)
	        set = true
	      end
	    end

	    node.fact_merge
	    node
	  end



!SLIDE bullets small

# What&#8217;s in a `node`?

	@@@ Ruby
	  def create_node(name, result)
	    node = Puppet::Node.new(name)
	    set = false
	    [:parameters, :classes, :environment].each do |param|
	      if value = result[param]
	        node.send(param.to_s + "=", value)
	        set = true
	      end
	    end

	    puts node.inspect
	    node.fact_merge
	    node
	  end



!SLIDE bullets

# What&#8217;s in a `node`?

<pre>
#&lt;Puppet::Node:0xb71eb704
@name="devstructure.hsd1.ca.comcast.net.",
@classes={}, @parameters={<strong>"foo"=&gt;"bar"</strong>},
@time=Sat Jan 08 22:23:12 +0000 2011&gt;
</pre>



!SLIDE bullets smaller

# From `lib/puppet/node.pp`

	@@@ Ruby
	  def fact_merge
	      if facts = Puppet::Node::Facts.indirection.find(name)
	        merge(facts.values)
	      end
	  rescue => detail
	      error = Puppet::Error.new(
	        "Could not retrieve facts for #{name}: #{detail}")
	      error.set_backtrace(detail.backtrace)
	      raise error
	  end



!SLIDE bullets

# Facts terminus

	$ puppet --genconfig | grep facts_terminus
	    # facts_terminus = facter
	$



!SLIDE bullets smaller

# From `lib/puppet/ indirector/facts/facter.rb`

	@@@ Ruby
	  def find(request)
	    result = Puppet::Node::Facts.new(request.key, Facter.to_hash)

	    result.add_local_facts
	    result.stringify
	    result.downcase_if_necessary

	    result
	  end



!SLIDE bullets smaller

# What are our options?

	$ ls -l lib/puppet/indirector/facts/
	total 24
	-rw-r--r-- 1 rcrowley rcrowley 1067 2010-12-22 01:10 active_record.rb
	-rw-r--r-- 1 rcrowley rcrowley  674 2010-12-22 01:10 couch.rb
	-rw-r--r-- 1 rcrowley rcrowley 2296 2010-12-22 01:10 facter.rb
	-rw-r--r-- 1 rcrowley rcrowley  358 2010-12-22 01:10 memory.rb
	-rw-r--r-- 1 rcrowley rcrowley  262 2010-12-22 01:10 rest.rb
	-rw-r--r-- 1 rcrowley rcrowley  235 2010-12-22 01:10 yaml.rb
	$



!SLIDE bullets smaller

# See the pattern?

	lib/puppet/indirector/node/plain.rb:15:in `find'
	lib/puppet/indirector/indirection.rb:193:in `find'
	lib/puppet/indirector/catalog/compiler.rb:91:in `find_node'
	lib/puppet/indirector/catalog/compiler.rb:119:in `node_from_request'
	lib/puppet/indirector/catalog/compiler.rb:33:in `find'
	lib/puppet/indirector/indirection.rb:193:in `find'
	# ...

	lib/puppet/indirector/node/exec.rb:17:in `find'
	lib/puppet/indirector/indirection.rb:193:in `find'
	lib/puppet/indirector/catalog/compiler.rb:91:in `find_node'
	lib/puppet/indirector/catalog/compiler.rb:119:in `node_from_request'
	lib/puppet/indirector/catalog/compiler.rb:33:in `find'
	lib/puppet/indirector/indirection.rb:193:in `find'
	# ...

* The catalog compiler is itself an indirection we can change!



!SLIDE bullets

# Catalog terminus

	$ puppet --genconfig | grep catalog_terminus
	    # catalog_terminus = compiler
	$



!SLIDE bullets smaller

# What are our options?

	$ ls -l lib/puppet/indictor/catalog/
	total 24
	-rw-r--r-- 1 rcrowley rcrowley 1198 2010-12-22 01:11 active_record.rb
	-rw-r--r-- 1 rcrowley rcrowley 4933 2011-01-08 22:18 compiler.rb
	-rw-r--r-- 1 rcrowley rcrowley  140 2010-12-22 01:10 queue.rb
	-rw-r--r-- 1 rcrowley rcrowley  189 2010-12-22 01:10 rest.rb
	-rw-r--r-- 1 rcrowley rcrowley  534 2010-12-22 01:10 yaml.rb
	$



!SLIDE bullets

# Blazing our own trail



!SLIDE bullets

# DNS TXT record<br />node terminus



!SLIDE bullets smaller

# `lib/puppet/indirector/node/dns.rb`

	@@@ Ruby
	require 'puppet/node'
	require 'puppet/indirector/plain'
	require 'resolv'

	class Puppet::Node::Dns < Puppet::Indirector::Plain

	  def find(request)
	    node = super
	    begin
	      resolver = Resolv::DNS.new
	      resource = resolver.getresource(
	        request.key, Resolv::DNS::Resource::IN::TXT)
	      node.classes += resource.data.split
	    rescue Resolv::ResolvError
	    end
	    node.fact_merge
	    node
	  end

	end



!SLIDE bullets

# Example record

	foo.example.com. IN TXT foo bar baz quux
	#   certname   #        #   @classes   #



!SLIDE bullets

# Hierarchical<br />facts terminus



!SLIDE bullets smaller

# `lib/puppet/indirector/facts/hier.rb`

	@@@ Ruby
	require 'puppet/indirector/facts/facter'

	class HierValue < Hash
	  attr_accessor :top
	  def initialize(top=nil)
	    @top = top
	  end
	  def to_s
	    @top
	  end
	end

	class Puppet::Node::Facts::Hier < Puppet::Node::Facts::Facter
	  def destroy(facts)
	  end
	  def save(facts)
	  end
	end



!SLIDE bullets smaller

# `lib/puppet/indirector/facts/hier.rb`

	@@@ Ruby
	class Puppet::Node::Facts::Hier < Puppet::Node::Facts::Facter
	  def find(request)
	    hier = {}
	    super.values.reject do |key, value|
	      Symbol === key
	    end.each do |key, value|
	      value = value.split(",") if value.index(",")
	      h = hier
	      if key.index("_") and keys = key.split("_")
	        while 1 < keys.length and key = keys.shift
	          h = HierValue === h[key] ?
	            h[key] : h[key] = HierValue.new(h[key])
	        end
	        key = keys.shift
	      end
	      if HierValue === h[key]
	        h[key].top = value
	      else
	        h[key] = value
	      end
	    end
	    Puppet::Node::Facts.new(request.key, hier)
	  end
	end



!SLIDE bullets smaller

# Example

	{"kernel"=>"Linux",
	 "netmask"=>{"eth0"=>"255.255.255.0", "eth1"=>"255.255.255.0"},
	 "ipaddress"=>{"eth0"=>"10.0.2.15", "eth1"=>"33.33.33.33"},
	 "kernelrelease"=>"2.6.35-22-generic-pae",
	 "ps"=>"ps -ef",
	 "network"=>{"eth0"=>"10.0.2.0", "eth1"=>"33.33.33.0"},
	 "interfaces"=>["eth0", "eth1"],
	 "kernelversion"=>"2.6.35",
	 "puppetversion"=>"2.6.4",
	 "hostname"=>"devstructure",
	 "uptime"=>{"seconds"=>"858930", "days"=>"9", "hours"=>"238"}}

	facts["ipaddress"] # => "10.0.2.15"
	facts["ipaddress"]["eth1"] # => "33.33.33.33"



!SLIDE bullets

# Caching catalog terminus



!SLIDE bullets smaller

# `lib/puppet/indirector/ catalog/caching_compiler.rb`

	@@@ Ruby
	require 'puppet/indirector/catalog/compiler'

	class Puppet::Resource::Catalog::CachingCompiler <
	  Puppet::Resource::Catalog::Compiler

	  @commit, @cache = `git rev-parse HEAD`.chomp, {}

	  def self.cache
	    commit = `git rev-parse HEAD`.chomp
	    @commit, @cache = commit, {} if @commit != commit
	    @cache
	  end

	  def find(request)
	    self.class.cache[request.key] ||= super
	  end

	end



!SLIDE bullets

# Limitations

* In-process cache is not<br />shared between masters.
* Invalidation brings a<br />thundering herd when `HEAD` moves.



!SLIDE bullets

* [github.com/rcrowley/extending-puppet](https://github.com/rcrowley/extending-puppet)



!SLIDE bullets smaller

# Further reading

* [docs.puppetlabs.com/guides/custom_types.html](http://docs.puppetlabs.com/guides/custom_types.html)
* [docs.puppetlabs.com/guides/provider_development.html](http://docs.puppetlabs.com/guides/provider_development.html)
* [docs.puppetlabs.com/guides/complete_resource_example.html](http://docs.puppetlabs.com/guides/complete_resource_example.html)
* [docs.puppetlabs.com/guides/custom_functions.html](http://docs.puppetlabs.com/guides/custom_functions.html)
* [projects.puppetlabs.com/projects/puppet/wiki](http://projects.puppetlabs.com/projects/puppet/wiki)



!SLIDE bullets

# One more thing:<br />Puppet faces

* New in 2.7.
* Formerly a module called `puppet-interfaces`.



!SLIDE bullets smaller

# Puppet faces

	@@@ Ruby
	require 'puppet/face'

	Puppet::Face.define(:configurer, '0.0.1') do
	  action(:synchronize) do
	    when_invoked do |certname, options|
	      facts = Puppet::Face[:facts, '0.0.1'].find(certname)
	      catalog = Puppet::Face[:catalog, '0.0.1'].
	        download(certname, facts)
	      report = Puppet::Face[:catalog, '0.0.1'].apply(catalog)
	      report
	    end
	  end
	end



!SLIDE bullets small

# Puppet faces

* [github.com/puppetlabs/puppet/tree/next/lib/puppet/face](https://github.com/puppetlabs/puppet/tree/next/lib/puppet/face)



!SLIDE bullets

# Thank you

* <richard@devstructure.com> or [@rcrowley](http://twitter.com/rcrowley)
* P.S. use DevStructure.
